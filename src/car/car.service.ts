import { Injectable, NotFoundException } from '@nestjs/common';
import { Interval, SchedulerRegistry } from '@nestjs/schedule';
import { Car } from './entities/car.entity';

@Injectable()
export class CarService {
  private carArr: Car[] = [
    {
      custId: 'test1234', // 고객사ID
      carList: [
        '01가1001',
        '01가1002',
        '01가1003',
        '01가1004',
        '01가1005',
        '01가1006',
        '01가1007',
        '01가1008',
        '01가1009',
        '01가1010',
        '01가1011',
        '01가1012',
        '01가1013',
        '01가1014',
        '01가1015',
        '01가1016',
      ], // 차량 번호 입력
      lat_lon: new Map([
        [
          '01가1001', // carList 첫 번째 차량
          [
            // 위도, 경도
            [34.9296943, 127.5092939],
            [34.9298464, 127.5090899],
            [34.9300095, 127.5088615],
            [34.9302875, 127.5088025],
            [34.9306621, 127.5086846],
            [34.9307105, 127.508316],
            [34.9306319, 127.5077411],
            [34.9305836, 127.5072989],
            [34.9305048, 127.5069251],
            [34.9304916, 127.5065496],
            [34.9304169, 127.505938],
            [34.9303289, 127.5055411],
            [34.9303025, 127.5051334],
            [34.9302365, 127.5047203],
            [34.9301442, 127.5042268],
            [34.9300782, 127.5037064],
            [34.9298275, 127.5030413],
            [34.9294977, 127.5031217],
            [34.929159, 127.5033095],
            [34.9288178, 127.5034919],
            [34.9285379, 127.5036833],
            [34.9280685, 127.5040616],
            [34.9276474, 127.5045697],
            [34.9273362, 127.5049556],
            [34.9270982, 127.5053926],
            [34.9269387, 127.5058583],
            [34.9268158, 127.5061996],
            [34.9267373, 127.5065058],
          ],
        ],
        [
          '01가1002', // carList 두 번째 차량
          [
            [34.9267111, 127.5066047],
            [34.9265803, 127.5070321],
            [34.9263031, 127.5077019],
            [34.925984, 127.5083654],
            [34.9256649, 127.5088247],
            [34.9251523, 127.5093351],
            [34.9247548, 127.5097498],
            [34.9249588, 127.5104387],
            [34.9251732, 127.5109809],
            [34.925419, 127.5117719],
            [34.9256334, 127.51248],
            [34.9258217, 127.5131179],
            [34.9259734, 127.5136027],
            [34.9263395, 127.5136027],
            [34.9267893, 127.5133156],
            [34.9274169, 127.5130987],
            [34.9279556, 127.5130796],
            [34.92851, 127.5127989],
            [34.9289284, 127.5124927],
            [34.9289859, 127.5118548],
            [34.9286878, 127.5113636],
            [34.9286303, 127.5106682],
            [34.9287715, 127.5103365],
            [34.9291982, 127.5103303],
            [34.9295957, 127.5101325],
            [34.9297265, 127.5097944],
          ],
        ],
        [
          '01가1003', // carList 세 번째 차량
          [
            [3, 126.8747403],
            [3, 126.8750192],
            [3, 126.8752016],
            [3, 126.8754054],
            [3, 126.8755771],
            [3, 126.8756951],
          ],
        ],
        [
          '01가1004', //1
          [
            [34.9303388, 127.5088231],
            [34.9302369, 127.508307],
            [34.9301226, 127.5076096],
            [34.9300258, 127.5069122],
            [34.9297971, 127.5066225],
            [34.9299554, 127.5059251],
            [34.929973, 127.5052063],
            [34.929929, 127.5045304],
            [34.9297003, 127.5041549],
            [34.9289614, 127.5046913],
            [34.9285304, 127.5052599],
            [34.9286008, 127.5060216],
            [34.9291286, 127.5068584],
            [34.9294189, 127.5077596],
            [34.9296476, 127.5084784],
            [34.9298939, 127.5089827],
          ],
        ],
        [
          '01가1005', // 2
          [
            [34.9298499, 127.5090578],
            [34.9296652, 127.5083604],
            [34.9295245, 127.5078883],
            [34.9292958, 127.507266],
            [34.9290671, 127.5065579],
            [34.9286801, 127.5061609],
            [34.9284162, 127.5055064],
            [34.9279236, 127.5058819],
            [34.9278972, 127.5067295],
            [34.927431, 127.506869],
            [34.926868, 127.5068046],
            [34.9271847, 127.5073947],
            [34.9272551, 127.5081672],
            [34.9274398, 127.5087895],
            [34.9275981, 127.5090363],
            [34.9276861, 127.5097229],
            [34.9280467, 127.5101735],
            [34.9289439, 127.5103452],
            [34.929586, 127.5102057],
            [34.9297443, 127.5098302],
          ],
        ],
        [
          '01가1006', // 3
          [
            [34.9297692, 127.5100047],
            [34.9299745, 127.5103764],
            [34.9298688, 127.5109833],
            [34.929477, 127.5112716],
            [34.9290914, 127.5113551],
            [34.9286933, 127.5113323],
            [34.9282579, 127.5110364],
            [34.9278785, 127.510604],
            [34.9284445, 127.5102171],
            [34.9289545, 127.510384],
            [34.9294583, 127.5102323],
            [34.92962, 127.5101261],
          ],
        ],
        [
          '01가1007', // 4
          [
            [34.9296816, 127.5094395],
            [34.9297696, 127.5088387],
            [34.9295761, 127.5081628],
            [34.9292594, 127.507959],
            [34.9285733, 127.5081092],
            [34.9281071, 127.5082701],
            [34.9277728, 127.50871],
            [34.9276497, 127.5092035],
            [34.9276761, 127.5097292],
            [34.928028, 127.5101691],
            [34.9287493, 127.5103193],
            [34.9293035, 127.5102978],
            [34.9297345, 127.5100403],
          ],
        ],
        [
          '01가1008', // 남부대학교 01가1008 // 5
          [
            [34.9278885, 127.5107025],
            [34.9277997, 127.5112438],
            [34.9273781, 127.5115866],
            [34.9269343, 127.511749],
            [34.9268973, 127.5123896],
            [34.926631, 127.5128046],
            [34.9270156, 127.5130662],
            [34.927378, 127.5129128],
            [34.9276665, 127.5124798],
            [34.9280141, 127.5122362],
            [34.9285097, 127.5124708],
            [34.9288869, 127.5123806],
            [34.9288943, 127.5117581],
            [34.9286579, 127.5113105],
            [34.9282101, 127.5109843],
          ],
        ],
        [
          '01가1009', // 6
          [
            [34.9256527, 127.5126958],
            [34.9253568, 127.5129665],
            [34.9251497, 127.513589],
            [34.9247503, 127.5132913],
            [34.9246246, 127.5126417],
            [34.9245062, 127.5120463],
            [34.9248834, 127.5116493],
            [34.925305, 127.5116493],
            [34.9255121, 127.5121365],
            [34.9256452, 127.5125786],
          ],
        ],
        [
          '01가1010', // 7
          [
            [34.9253216, 127.5110381],
            [34.9256202, 127.5106891],
            [34.9256824, 127.5102643],
            [34.9256886, 127.5098243],
            [34.9257508, 127.5092098],
            [34.9255953, 127.508967],
            [34.9252221, 127.5092325],
            [34.9249235, 127.509536],
            [34.9247867, 127.5100215],
            [34.9249733, 127.5103325],
            [34.9250915, 127.5106966],
          ],
        ],
        [
          '01가1011', // 8
          [
            [34.9268331, 127.5091549],
            [34.9269219, 127.5085324],
            [34.9267074, 127.5077836],
            [34.926737, 127.5071611],
            [34.9268775, 127.5066108],
            [34.9266704, 127.5068093],
            [34.9263967, 127.5074408],
            [34.9261304, 127.5079821],
            [34.9258197, 127.5086136],
            [34.9257457, 127.5091008],
            [34.9261895, 127.5091549],
            [34.9265741, 127.5091639],
          ],
        ],
        [
          '01가1012', // 9
          [
            [34.9250383, 127.5114484],
            [34.9250668, 127.5110588],
            [34.9248729, 127.5105718],
            [34.9246276, 127.5103005],
            [34.9242568, 127.5106762],
            [34.9240343, 127.5110588],
            [34.923983, 127.5114136],
            [34.9240172, 127.5121023],
            [34.9240799, 127.5125545],
            [34.9241312, 127.5131458],
            [34.9242168, 127.513751],
            [34.9244963, 127.5137093],
            [34.9246389, 127.5131388],
            [34.9247016, 127.5126379],
            [34.9245077, 127.5122483],
            [34.9245819, 127.5117892],
            [34.9248672, 127.5116571],
            [34.925044, 127.5114901],
          ],
        ],
        [
          '01가1013', // 10
          [
            [34.9240173, 127.5122067],
            [34.9239203, 127.5117336],
            [34.9238461, 127.5111771],
            [34.9234354, 127.5110171],
            [34.9231844, 127.5114276],
            [34.9229277, 127.5118172],
            [34.9227109, 127.5123111],
            [34.9224086, 127.5129024],
            [34.9221861, 127.5135285],
            [34.9221462, 127.5145511],
            [34.9224573, 127.5150589],
            [34.9228708, 127.5148443],
            [34.9233018, 127.5145224],
            [34.9237152, 127.5142864],
            [34.9241374, 127.5142113],
            [34.9241638, 127.5135783],
            [34.9240934, 127.5130955],
          ],
        ],
        [
          '01가1014', // 11
          [
            [34.929105, 127.4982762],
            [34.9288397, 127.4980718],
            [34.9285255, 127.4977312],
            [34.9285534, 127.4982847],
            [34.9285743, 127.4988723],
            [34.9285394, 127.4994428],
            [34.9285115, 127.5002092],
            [34.9283998, 127.5008819],
            [34.9281275, 127.501214],
            [34.9284347, 127.5013588],
            [34.9287977, 127.5011204],
            [34.9292934, 127.5009671],
            [34.9296425, 127.5006776],
            [34.9297263, 127.4997239],
            [34.9295099, 127.4991278],
          ],
        ],
        [
          '01가1015', // 12
          [
            [34.9282134, 127.4972268],
            [34.9282628, 127.4968354],
            [34.9282825, 127.4964139],
            [34.928164, 127.4960285],
            [34.9279073, 127.4958479],
            [34.9276358, 127.4963115],
            [34.9274186, 127.4969377],
            [34.9274186, 127.4974917],
            [34.9277642, 127.4976061],
            [34.9280851, 127.4975098],
            [34.9282184, 127.4971485],
          ],
        ],
        [
          '01가1016', // 13
          [
            [34.9285886, 127.4992138],
            [34.928559, 127.4987803],
            [34.9285541, 127.4982143],
            [34.9283863, 127.4977988],
            [34.9281493, 127.4975278],
            [34.9277642, 127.4975579],
            [34.9273643, 127.4978289],
            [34.9273692, 127.4985876],
            [34.9272705, 127.4991958],
            [34.9272557, 127.4999063],
            [34.9273791, 127.5006529],
            [34.9275914, 127.5010443],
            [34.9276161, 127.5015682],
            [34.928016, 127.5013454],
            [34.9282925, 127.5009721],
            [34.9285048, 127.5005325],
            [34.9285492, 127.4996112],
          ],
        ],
      ]),
    }, // index : carArr[0]
    {
      custId: 'test2222',
      carList: ['02가1001', '02가1002'],
      lat_lon: new Map([
        [
          '02가1001',
          [
            [35.1104359, 126.8758168],
            [35.1101437, 126.8758168],
            [35.1098723, 126.8757785],
            [35.1096531, 126.8757657],
            [35.109413, 126.8757147],
          ],
        ],
        [
          '02가1002',
          [
            [35.1104359, 126.8758168],
            [35.1101437, 126.8758168],
            [35.1098723, 126.8757785],
            [35.1096531, 126.8757657],
            [35.109413, 126.8757147],
          ],
        ],
      ]),
    }, // index : carArr[1]
    {
      custId: 'test3333',
      carList: ['03가1001'],
      lat_lon: new Map([
        [
          '03가1001',
          [
            [33333, 126.8758168],
            [33333, 126.8758168],
            [33333, 126.8757785],
            [33333, 126.8757657],
            [33333, 126.8757147],
          ],
        ],
      ]),
    }, // index : carArr[2]
  ];
  @Interval(5000) // 5초
  interval() {
    for (let i = 0; i < this.carArr.length; i++) {
      for (let j = 0; j < this.carArr[i].carList.length; j++) {
        const tempArr = this.carArr[i].lat_lon.get(
          this.carArr[i].carList[j],
        )[0];
        this.carArr[i].lat_lon.get(this.carArr[i].carList[j]).shift();
        this.carArr[i].lat_lon.get(this.carArr[i].carList[j]).push(tempArr);

        // 전체 차량 위도 경도 console.log
        console.log(
          `${i + 1}-${j + 1} : ${
            this.carArr[i].lat_lon.get(this.carArr[i].carList[j])[0]
          }`,
        );
      }
    }
  }

  async getCarLocation(data) {
    const carInfo = [];
    let rsltCd = '301';
    if (!data.custId || !data.carList || !data.carList[0].carNum) {
      return {
        rsltCd: rsltCd,
        infoList: carInfo,
      };
    }
    await this.carArr.forEach((car) => {
      if (car.custId === data.custId) {
        rsltCd = '000';
        for (let i = 0; i < car.carList.length; i++) {
          for (let j = 0; j < data.carList.length; j++) {
            if (car.carList[i] === data.carList[j].carNum) {
              carInfo.push({
                carNum: car.carList[i],
                gpsLat: car.lat_lon.get(car.carList[i])[0][0],
                gpsLong: car.lat_lon.get(car.carList[i])[0][1],
              });
            }
          }
        }
      }
    });

    if (carInfo.length <= 0) {
      rsltCd = '302';
    }

    return {
      rsltCd: rsltCd,
      infoList: carInfo,
    };
  }
}
